<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Veltrax Data Flow Simulator</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
  <script src="https://cdn.jsdelivr.net/npm/d3-sankey@0.12.3/dist/d3-sankey.min.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
    html,body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    .card{border:1px solid #e5e7eb;border-radius:1rem;background:#fff;box-shadow:0 1px 2px rgba(0,0,0,.05)}
    .badge{background:linear-gradient(135deg,#7c3aed,#4338ca);color:#fff}
    .ring{box-shadow:0 0 0 2px rgba(124,58,237,.2)}
    .muted{color:#64748b}
  </style>
</head>
<body class="bg-slate-50 text-slate-900">
<header class="max-w-7xl mx-auto px-6 md:px-8 pt-8 pb-4">
  <div class="flex items-center gap-4">
    <!-- ====== Replace LOGO_URL below to show your logo ====== -->
    <div id="logo" class="h-10 w-10 rounded-xl badge flex items-center justify-center text-lg font-semibold">V</div>
    <div>
      <h1 class="text-2xl md:text-3xl font-semibold">Veltrax Data Flow Simulator</h1>
      <p class="muted">Turn up data sources. See how Veltrax apps route, process, and prove value — live.</p>
    </div>
    <div class="ml-auto flex gap-2">
      <button id="btnPlay" class="px-3 py-2 rounded-lg bg-slate-900 text-white">Start</button>
      <button id="btnReset" class="px-3 py-2 rounded-lg border border-slate-300">Reset</button>
    </div>
  </div>
  <div class="mt-3 flex flex-wrap items-center gap-4">
    <label class="flex items-center gap-2 text-sm"><input id="toggleRag" type="checkbox" class="accent-purple-600">
      <span>Docs/RAG heavy workload</span>
    </label>
    <label class="flex items-center gap-2 text-sm"><input id="toggleCloud" type="checkbox" class="accent-purple-600">
      <span>Simulate cloud mode (adds network latency & cost)</span>
    </label>
  </div>
</header>

<main class="max-w-7xl mx-auto px-6 md:px-8 pb-12 grid grid-cols-1 lg:grid-cols-3 gap-6">
  <!-- Sources -->
  <section class="card p-5 lg:col-span-1">
    <h2 class="text-lg font-semibold mb-3">Data sources (events/day)</h2>
    <div id="sources" class="space-y-4"></div>
  </section>

  <!-- Apps + KPIs -->
  <section class="lg:col-span-2 grid grid-cols-1 md:grid-cols-3 gap-6">
    <div class="card p-5">
      <h3 class="text-lg font-semibold mb-3">Veltrax apps (max events/sec)</h3>
      <div id="apps" class="space-y-4"></div>
      <p class="mt-4 text-xs muted">Capacity ≈ sustained local inference + pipeline throughput.</p>
    </div>

    <div class="card p-5">
      <h3 class="text-lg font-semibold mb-3">Live KPIs</h3>
      <div class="grid grid-cols-2 gap-3">
        <div class="p-3 rounded-xl bg-slate-100">
          <div class="text-xs muted">Ingest rate</div>
          <div id="kpiIngest" class="text-xl font-semibold">0 ev/s</div>
        </div>
        <div class="p-3 rounded-xl bg-slate-100">
          <div class="text-xs muted">Process rate</div>
          <div id="kpiProcess" class="text-xl font-semibold">0 ev/s</div>
        </div>
        <div class="p-3 rounded-xl bg-slate-100">
          <div class="text-xs muted">Queue size</div>
          <div id="kpiQueue" class="text-xl font-semibold">0</div>
        </div>
        <div class="p-3 rounded-xl bg-slate-100">
          <div class="text-xs muted">Est. latency</div>
          <div id="kpiLatency" class="text-xl font-semibold">0.0 s</div>
        </div>
        <div class="p-3 rounded-xl bg-slate-100 col-span-2">
          <div class="text-xs muted">Estimated ROI</div>
          <div id="kpiROI" class="text-xl font-semibold">+0.0%</div>
          <div class="text-xs muted mt-1">Simple model: value per processed event – cost per event.</div>
        </div>
      </div>
    </div>

    <div class="card p-5">
      <h3 class="text-lg font-semibold mb-3">Routing share</h3>
      <p class="text-sm muted mb-3">Adjust % of incoming events sent to each app. (Auto-normalized to 100%.)</p>
      <div id="routing" class="space-y-4"></div>
    </div>
  </section>

  <!-- Charts -->
  <section class="card p-5 lg:col-span-3">
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <div class="lg:col-span-2">
        <h3 class="font-semibold mb-2">Queue & latency</h3>
        <canvas id="chartQueue" height="180"></canvas>
      </div>
      <div>
        <h3 class="font-semibold mb-2">Throughput by app</h3>
        <canvas id="chartApps" height="180"></canvas>
      </div>
    </div>
  </section>

  <!-- Sankey -->
  <section class="card p-5 lg:col-span-3">
    <h3 class="font-semibold mb-2">Live data flow (Sankey)</h3>
    <svg id="sankey" width="100%" height="320"></svg>
    <p class="text-xs muted mt-2">Width of links reflects current events/sec from sources → apps after routing.</p>
  </section>
</main>

<script>
/* ===== 0) Brand: set your logo URL (SVG/PNG). Leave empty to use the “V” badge. ===== */
const LOGO_URL = ""; // e.g., "https://yourcdn.com/veltrax-logo.svg"
if(LOGO_URL){
  const img = new Image();
  img.src = LOGO_URL; img.alt = "Veltrax";
  img.className = "h-10 w-10 object-contain";
  const wrap = document.getElementById('logo'); wrap.replaceChildren(img);
}

/* ===== 1) Definitions ===================================================== */
const SOURCE_DEFS = [
  { key:'coreBanking', label:'Core Banking (SQL/Oracle)', maxDay: 2_000_000, value: 400_000 },
  { key:'pos',          label:'POS Terminals',            maxDay: 3_000_000, value: 600_000 },
  { key:'web',          label:'Web & Mobile Apps',        maxDay: 5_000_000, value: 800_000 },
  { key:'crm',          label:'CRM/Support',              maxDay: 1_500_000, value: 200_000 },
  { key:'docs',         label:'Files & Docs (RAG)',       maxDay:   300_000, value:  50_000 },
  { key:'edge',         label:'IoT / Edge Devices',       maxDay: 2_500_000, value: 300_000 },
];
const APP_DEFS = [
  { key:'finex',   label:'Finex (Banking/Fraud)',  capacity: 900, color:'#7c3aed'},
  { key:'verdict', label:'Verdict (Legal Ops)',    capacity: 400, color:'#06b6d4'},
  { key:'echelon', label:'Échelon (Retail Intel)', capacity: 500, color:'#10b981'},
];

const BASE_COST_LOCAL   = 0.0006;
const BASE_VALUE_EVENT  = 0.0014;
const CLOUD_LAT_MS      = 120;         // round-trip
const CLOUD_COST_FACTOR = 1.4;         // cloud overhead

/* ===== 2) UI builders ===================================================== */
const $sources = document.getElementById('sources');
const $apps    = document.getElementById('apps');
const $routing = document.getElementById('routing');

function rowSlider(id, label, min, max, step, value, suffix=''){
  return `
    <div class="grid grid-cols-7 gap-3 items-center">
      <label class="col-span-3 text-sm">${label}</label>
      <input id="${id}" type="range" min="${min}" max="${max}" step="${step}" value="${value}"
             class="col-span-3 w-full accent-purple-600" />
      <div class="col-span-1 text-right text-sm"><span id="${id}-val">${Number(value).toLocaleString()}</span>${suffix}</div>
    </div>`;
}

SOURCE_DEFS.forEach(s=>{
  $sources.insertAdjacentHTML('beforeend',
    rowSlider(`src-${s.key}`, s.label, 0, s.maxDay, Math.round(s.maxDay/100), s.value, '/d'));
});
APP_DEFS.forEach(a=>{
  $apps.insertAdjacentHTML('beforeend',
    rowSlider(`cap-${a.key}`, a.label, 0, 2000, 10, a.capacity, ' ev/s'));
});
APP_DEFS.forEach(a=>{
  $routing.insertAdjacentHTML('beforeend',
    rowSlider(`rt-${a.key}`, `${a.label} share`, 0, 100, 1, 33, ' %'));
});
function normalizeRouting(){
  const vals = APP_DEFS.map(a => +document.getElementById(`rt-${a.key}`).value);
  const sum = vals.reduce((a,b)=>a+b,0)||1;
  APP_DEFS.forEach((a,i)=>{
    const pct = Math.round(vals[i]*100/sum);
    const el = document.getElementById(`rt-${a.key}`);
    el.value = pct;
    document.getElementById(`rt-${a.key}-val`).textContent = pct;
  });
}
normalizeRouting();

document.addEventListener('input', e=>{
  if(e.target.matches('input[type="range"]')){
    const label = document.getElementById(e.target.id+'-val');
    if(label) label.textContent = Number(e.target.value).toLocaleString();
    if(e.target.id.startsWith('rt-')) normalizeRouting();
  }
});

/* ===== 3) State + charts ================================================== */
let queue=0, playing=false;
const tickMs=500, historyLen=60;

const qctx = document.getElementById('chartQueue');
const actx = document.getElementById('chartApps');

const queueChart = new Chart(qctx, {
  type:'line',
  data:{
    labels:Array(historyLen).fill(''),
    datasets:[
      { label:'Queue (events)', data:Array(historyLen).fill(0), borderColor:'#7c3aed', backgroundColor:'rgba(124,58,237,.12)', tension:.3 },
      { label:'Latency (s)',    data:Array(historyLen).fill(0), borderColor:'#0ea5e9', backgroundColor:'rgba(14,165,233,.12)', tension:.3, yAxisID:'y1' },
    ]
  },
  options:{
    responsive:true,
    plugins:{ legend:{display:true} },
    scales:{
      y:{beginAtZero:true,title:{display:true,text:'events'}},
      y1:{beginAtZero:true,position:'right',grid:{drawOnChartArea:false},title:{display:true,text:'seconds'}}
    }
  }
});

const appsChart = new Chart(actx, {
  type:'bar',
  data:{ labels:APP_DEFS.map(a=>a.label), datasets:[{ data:APP_DEFS.map(_=>0), backgroundColor:APP_DEFS.map(a=>a.color)}]},
  options:{ responsive:true, plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true,title:{display:true,text:'events/sec'}}}}
});

/* ===== 4) KPI hooks ======================================================= */
const $kpiIngest  = document.getElementById('kpiIngest');
const $kpiProcess = document.getElementById('kpiProcess');
const $kpiQueue   = document.getElementById('kpiQueue');
const $kpiLatency = document.getElementById('kpiLatency');
const $kpiROI     = document.getElementById('kpiROI');

const $toggleRag   = document.getElementById('toggleRag');
const $toggleCloud = document.getElementById('toggleCloud');

function dayToSec(x){ return x/86400; }

/* ===== 5) Sankey ========================================================== */
const sankeySvg = d3.select('#sankey');
function renderSankey(flows){
  const width = sankeySvg.node().clientWidth, height = +sankeySvg.attr('height');
  sankeySvg.selectAll('*').remove();

  const sankey = d3.sankey()
    .nodeWidth(12)
    .nodePadding(16)
    .extent([[10,10],[width-10,height-10]]);

  const nodes = [], nodeIndex = new Map();
  function idx(name){ if(!nodeIndex.has(name)){ nodeIndex.set(name, nodes.length); nodes.push({name}); } return nodeIndex.get(name); }

  const links = flows.map(f=>({source: idx(f.source), target: idx(f.target), value: Math.max(0.01,f.value)}));
  const graph = sankey({ nodes:nodes.map(d=>Object.assign({},d)), links:links });

  // links
  sankeySvg.append('g').selectAll('path')
    .data(graph.links)
    .enter().append('path')
    .attr('d', d3.sankeyLinkHorizontal())
    .attr('stroke', d=>d.target.color||'#94a3b8')
    .attr('stroke-width', d=>Math.max(1, d.width))
    .attr('fill','none')
    .attr('opacity', .35);

  // nodes
  sankeySvg.append('g').selectAll('rect')
    .data(graph.nodes)
    .enter().append('rect')
    .attr('x', d=>d.x0).attr('y', d=>d.y0)
    .attr('width', d=>d.x1-d.x0).attr('height', d=>Math.max(1,d.y1-d.y0))
    .attr('fill', d=>APP_DEFS.find(a=>a.label===d.name)?.color || '#334155');

  sankeySvg.append('g').selectAll('text')
    .data(graph.nodes).enter().append('text')
    .attr('x', d=>d.x0-6).attr('y', d=> (d.y0 + d.y1)/2 )
    .attr('dy','0.35em').attr('text-anchor','end')
    .style('font-size','12px').text(d=>d.name);
}

/* ===== 6) Simulation ====================================================== */
function step(){
  // ingest
  const ingestPerDay = SOURCE_DEFS.map(s=>+document.getElementById(`src-${s.key}`).value).reduce((a,b)=>a+b,0);
  const ingestSec = dayToSec(ingestPerDay);            // ev/s
  queue += ingestSec * (tickMs/1000);

  // routing & capacity
  const shares = APP_DEFS.map(a => (+document.getElementById(`rt-${a.key}`).value)/100);
  let caps = APP_DEFS.map(a => +document.getElementById(`cap-${a.key}`).value);

  // RAG overhead: Verdict handles more retrieval
  if($toggleRag.checked){
    const idx = APP_DEFS.findIndex(a=>a.key==='verdict');
    if(idx>=0) caps[idx] = Math.max(50, Math.round(caps[idx]*0.75)); // retrieval overhead reduces throughput
  }

  // how much each app processes this tick
  let processedTotal = 0;
  const processedPerApp = APP_DEFS.map((a,i)=>{
    const demand = ingestSec * shares[i];
    const available = Math.min(caps[i], queue * 2);
    const proc = Math.min(demand + (queue * shares[i]), available) * (tickMs/1000);
    processedTotal += proc;
    return proc;
  });

  // dequeue
  queue = Math.max(0, queue - processedTotal);

  // latency: base + queue/cap + optional cloud RTT
  const totalCap = caps.reduce((a,b)=>a+b,0);
  let latency = totalCap>0 ? queue/totalCap : 0;
  if($toggleCloud.checked) latency += CLOUD_LAT_MS/1000;

  // value & cost
  const processedEvPerSec = processedPerApp.reduce((a,b)=>a+b,0)/(tickMs/1000);
  const costPerEvent = $toggleCloud.checked ? BASE_COST_LOCAL*CLOUD_COST_FACTOR : BASE_COST_LOCAL;
  const value = processedEvPerSec * BASE_VALUE_EVENT;
  const cost  = processedEvPerSec * costPerEvent;
  const margin = value - cost;
  const roiPct = (margin / Math.max(cost,0.0001))*100;

  // KPIs
  document.getElementById('kpiIngest').textContent  = `${ingestSec.toFixed(1)} ev/s`;
  document.getElementById('kpiProcess').textContent = `${processedEvPerSec.toFixed(1)} ev/s`;
  document.getElementById('kpiQueue').textContent   = Math.round(queue).toLocaleString();
  document.getElementById('kpiLatency').textContent = `${latency.toFixed(2)} s`;
  document.getElementById('kpiROI').textContent     = `${roiPct>=0?'+':''}${roiPct.toFixed(1)}%`;

  // Charts
  queueChart.data.datasets[0].data.push(Math.round(queue));
  queueChart.data.datasets[0].data.shift();
  queueChart.data.datasets[1].data.push(+latency.toFixed(2));
  queueChart.data.datasets[1].data.shift();
  queueChart.update('none');

  appsChart.data.datasets[0].data = processedPerApp.map(v=> +(v/(tickMs/1000)).toFixed(1));
  appsChart.update('none');

  // Sankey flows: sources -> apps (ev/s)
  const flows = [];
  const labelsSources = {
    coreBanking:'Core Banking',
    pos:'POS',
    web:'Web/Mobile',
    crm:'CRM',
    docs:'Docs (RAG)',
    edge:'Edge/IoT'
  };
  const ingestSecPerSource = SOURCE_DEFS.map(s=>dayToSec(+document.getElementById(`src-${s.key}`).value));
  APP_DEFS.forEach((a,i)=>a.color = APP_DEFS[i].color);
  Object.entries(labelsSources).forEach(([k,label])=>{
    const srcRate = ingestSecPerSource[SOURCE_DEFS.findIndex(s=>s.key===k)];
    APP_DEFS.forEach((a,i)=>{
      const share = (+document.getElementById(`rt-${a.key}`).value)/100;
      flows.push({ source: label, target: a.label, value: srcRate*share });
    });
  });
  renderSankey(flows);
}

let timer=null;
document.getElementById('btnPlay').addEventListener('click',(e)=>{
  playing = !playing; e.target.textContent = playing ? 'Pause' : 'Start';
  if(playing){ timer = setInterval(step, tickMs); } else { clearInterval(timer); }
});
document.getElementById('btnReset').addEventListener('click', ()=>{
  queue=0;
  queueChart.data.datasets.forEach(d=>d.data=Array(historyLen).fill(0));
  queueChart.update();
  appsChart.data.datasets[0].data = APP_DEFS.map(_=>0); appsChart.update();
});
</script>
</body>
</html>
